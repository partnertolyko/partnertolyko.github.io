<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Auth Callback</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 40px; line-height: 1.5; }
    h1 { margin: 0 0 12px; }
    .box { background: #f6f6f6; padding: 14px 16px; border-radius: 10px; margin: 16px 0; }
    code { background: #eee; padding: 2px 6px; border-radius: 6px; }
    .ok { color: #1b7f3b; }
    .err { color: #c62828; }
    .row { margin: 6px 0; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; }
    .muted { opacity: .7; font-size: .95em; }
  </style>
</head>
<body>
  <h1 id="title">Авторизация</h1>

  <div id="panel" class="box">
    <div class="row" id="msg">⏳ Обрабатываем авторизацию...</div>
  </div>

  <p class="muted">Эта страница автоматически передаст код в приложение на вашем компьютере.</p>

  <script>
    (async function () {
      const esc = (s) => (s ?? "").toString()
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");

      const qs = new URLSearchParams(location.search);
      const code  = qs.get("code");
      const state = qs.get("state") || "";
      const err   = qs.get("error");
      const errd  = qs.get("error_description");

      const msg   = document.getElementById("msg");
      const title = document.getElementById("title");

      function setStatus(ok, html) {
        document.title = ok ? "Авторизация завершена" : "Ошибка авторизации";
        title.innerText = ok ? "Авторизация завершена" : "Ошибка авторизации";
        msg.innerHTML = html;
      }

      if (err) {
        setStatus(false,
          "❌ Ошибка: <code>" + esc(err) + "</code>" +
          (errd ? "<br>Описание: <code>" + esc(errd) + "</code>" : "")
        );
        return;
      }

      if (!code) {
        setStatus(false, "❌ В ответе нет параметра <code>code</code>.");
        return;
      }

      try {
        // Отправляем code в локальное приложение
        await fetch("http://localhost:8080/callback?code=" + encodeURIComponent(code) + "&state=" + encodeURIComponent(state));
        setStatus(true, "✅ Код успешно передан в приложение. Можете закрыть вкладку.");
      } catch (e) {
        setStatus(false, "❌ Не удалось связаться с приложением.<br>Убедитесь, что оно запущено.");
      }
    })();
  </script>
</body>
</html>
