<!doctype html>
<html lang="ru" referrerpolicy="no-referrer">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Auth Callback</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 40px; line-height: 1.5; }
    h1 { margin: 0 0 12px; }
    .box { background: #f6f6f6; padding: 14px 16px; border-radius: 10px; margin: 16px 0; }
    code { background: #eee; padding: 2px 6px; border-radius: 6px; }
    .ok { color: #1b7f3b; }
    .err { color: #c62828; }
    .row { margin: 6px 0; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; }
    .muted { opacity: .7; font-size: .95em; }
  </style>
  <meta name="referrer" content="no-referrer">
</head>
<body>
  <h1 id="title">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h1>

  <div id="panel" class="box">
    <div class="row" id="msg"></div>
    <div class="row" id="pairs" hidden>
      <div>–ö–æ–¥: <code id="c"></code></div>
      <div>State: <code id="s"></code></div>
    </div>

    <div class="row" id="actions" hidden>
      <button id="copyCode">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–¥</button>
      <button id="copyUrl">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π URL</button>
      <button id="hide">–°–∫—Ä—ã—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</button>
      <button id="close">–ó–∞–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫—É</button>
    </div>
  </div>

  <p class="muted">–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∏—á–µ–≥–æ –Ω–∏–∫—É–¥–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç ‚Äî –¥–∞–Ω–Ω—ã–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.</p>

  <script>
    (function () {
      const esc = (s) => (s ?? "").toString()
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");

      const qs = new URLSearchParams(location.search);
      const code  = qs.get("code");
      const state = qs.get("state") || "";
      const err   = qs.get("error");
      const errd  = qs.get("error_description");

      const $ = (id) => document.getElementById(id);
      const msg     = $("msg");
      const pairs   = $("pairs");
      const actions = $("actions");
      const codeEl  = $("c");
      const stateEl = $("s");

      function setStatus(ok, html) {
        document.title = ok ? "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞" : "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏";
        document.querySelector("h1").innerText = ok ? "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞" : "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏";
        msg.innerHTML = html;
      }

      async function copyToClipboard(text) {
        try {
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
            return true;
          }
        } catch (_) {}
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.opacity = "0";
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand("copy"); } catch (_) {}
        document.body.removeChild(ta);
        return true;
      }

      function hideQuery() {
        if (history && history.replaceState) {
          history.replaceState({}, "", location.pathname);
        }
      }

      if (err) {
        setStatus(false,
          "<p class='err'>‚ùå –û—à–∏–±–∫–∞: <code>" + esc(err) + "</code></p>" +
          (errd ? "<p class='err'>–û–ø–∏—Å–∞–Ω–∏–µ: <code>" + esc(errd) + "</code></p>" : "")
        );
        return;
      }

      if (!code) {
        setStatus(false, "<p class='err'>‚ùå –í –æ—Ç–≤–µ—Ç–µ –Ω–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ <code>code</code>.</p>");
        return;
      }

      // –£—Å–ø–µ—Ö
      setStatus(true, "<p class='ok'>‚úÖ –ü–æ–ª—É—á–µ–Ω –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–ª–Ω—ã–π URL —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.</p>");
      codeEl.textContent  = code;
      stateEl.textContent = state;
      pairs.hidden = false;
      actions.hidden = false;

      // –ê–≤—Ç–æ–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ URL
      copyToClipboard(window.location.href).then(() => {
        const note = document.createElement("p");
        note.className = "ok";
        note.textContent = "–ü–æ–ª–Ω—ã–π URL —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.";
        document.getElementById("panel").appendChild(note);
      }).finally(hideQuery);

      // üöÄ –ê–≤—Ç–æ–ø–µ—Ä–µ–¥–∞—á–∞ –∫–æ–¥–∞ –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
      fetch("http://localhost:8080/callback?code=" + encodeURIComponent(code))
        .catch(err => console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä:", err));

      // –ö–Ω–æ–ø–∫–∏
      $("copyCode").onclick = () => copyToClipboard(code);
      $("copyUrl").onclick  = () => copyToClipboard(window.location.href);
      $("hide").onclick     = hideQuery;
      $("close").onclick    = () => window.close();
    })();
  </script>
</body>
</html>
