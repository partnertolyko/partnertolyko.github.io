<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Auth Callback</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 40px; line-height: 1.5; }
    h1 { margin: 0 0 12px; }
    .box { background: #f6f6f6; padding: 14px 16px; border-radius: 10px; margin: 16px 0; }
    code { background: #eee; padding: 2px 6px; border-radius: 6px; }
    .ok { color: #1b7f3b; }
    .err { color: #c62828; }
    .row { margin: 6px 0; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; }
    .muted { opacity: .7; font-size: .95em; }
  </style>
</head>
<body>
  <h1 id="title">Авторизация</h1>

  <div id="panel" class="box">
    <div class="row" id="msg"></div>
    <div class="row" id="pairs" hidden>
      <div>Код: <code id="c"></code></div>
      <div>State: <code id="s"></code></div>
    </div>

    <div class="row" id="actions" hidden>
      <button id="copyCode">Скопировать только код</button>
      <button id="copyUrl">Скопировать полный URL</button>
      <button id="hide">Скрыть параметры</button>
      <button id="close">Закрыть вкладку</button>
    </div>
  </div>

  <p class="muted">Эта страница не отправляет данные наружу. Если локальный сервер работает — вы будете перенаправлены автоматически.</p>

  <script>
    (function () {
      const esc = (s) => (s ?? "").toString()
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");

      const qs = new URLSearchParams(location.search);
      const code  = qs.get("code");
      const state = qs.get("state") || "";
      const err   = qs.get("error");
      const errd  = qs.get("error_description");

      const $ = (id) => document.getElementById(id);
      const msg     = $("msg");
      const pairs   = $("pairs");
      const actions = $("actions");
      const codeEl  = $("c");
      const stateEl = $("s");

      function setStatus(ok, html) {
        document.title = ok ? "Авторизация завершена" : "Ошибка авторизации";
        $("title").innerText = document.title;
        msg.innerHTML = html;
      }

      // Если ошибка — показываем её
      if (err) {
        setStatus(false,
          "<p class='err'>❌ Ошибка: <code>" + esc(err) + "</code></p>" +
          (errd ? "<p class='err'>Описание: <code>" + esc(errd) + "</code></p>" : "")
        );
        return;
      }

      if (!code) {
        setStatus(false, "<p class='err'>❌ В ответе нет параметра <code>code</code>.</p>");
        return;
      }

      // --- Новый блок: автоматический редирект на локальный сервер ---
      const redirectUrl = "http://localhost:8080/callback?code=" + encodeURIComponent(code) +
                          (state ? "&state=" + encodeURIComponent(state) : "");
      try {
        window.location.replace(redirectUrl);
      } catch (e) {
        console.warn("Редирект не удался:", e);
      }

      // --- fallback: показываем код на странице ---
      setStatus(true, "<p class='ok'>✅ Получен authorization code. Попытка пересылки в локальное приложение...</p>");
      codeEl.textContent  = code;
      stateEl.textContent = state;
      pairs.hidden = false;
      actions.hidden = false;

      $("copyCode").onclick = () => navigator.clipboard.writeText(code);
      $("copyUrl").onclick  = () => navigator.clipboard.writeText(window.location.href);
      $("hide").onclick     = () => history.replaceState({}, "", location.pathname);
      $("close").onclick    = () => window.close();
    })();
  </script>
</body>
</html>
